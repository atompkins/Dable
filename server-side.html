<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="description" content="Dable (pronounced 'dabble') is a simple javascript table control with filtering, sorting, paging, styles, and more!">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<link href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
		<script data-main="js/main" src="js/require.js" type="text/javascript"></script>
		<script type="text/javascript">
			require(['templateBuilder']);
		</script>
		<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
		<title>Server Side Dable</title>
	</head>
	<body data-spy="scroll" data-target="#affixed" data-offset="0">
		{{{navbar}}}
	    <div class="container">
			<div class="row">
				<div class="col-md-9">
					<div class="page-header">
						<h1>Server Side Filtering/Sorting</h1>
					</div>
					<a class="anchor" id="basics"></a>
					<p class="lead">Dable works with server side data</p>
					<p>Sometimes there's just too much data.  Your client might want to have a table that displays a million rows of data or some absurd number.  When this happens, even the best coded software has to admit, your customer's computer just isn't fast enough to parse a million rows on the client side.  Never fret!  Dable supports server side data sources!</p>
					<p>The properties that are the most important to remember here are these:
<pre class="prettyprint lang-js">
async: false,		// url of the server side api
asyncData: {},		// extra data to send with each request
asyncStart: 0,		// what item number to start with, this is changed as dable runs
asyncLength: 1000,	// the number of records to return with each request
</pre>
					The <em>async</em> property is the most important.  You need to set async to the url that you want Dable to use for your server side data source.  Dable sends <strong>POST</strong> requests to this url with JSON data.</p>
					<p>The <em>asyncData</em> property allows you to modify the JSON data object that Dable sends to your server with custom properties.  By default, the request includes these properties.</p>
<pre class="prettyprint lang-js">
start: Number,		// dable.asyncStart
count: Number,		// dable.asyncLength
filter: String,		// The text in your search box
sortColumn: Number,	// -1 if null, 0 based index of column
</pre>
					<p>In response, dable expects these properties:</p>
<pre class="prettyprint lang-js">
object: {
	rows: [],                   // the rows as an array of arrays.
	includedRowCount: Number,   // the number of rows after the filter, saved to dable.VisibleRowCount, replaces the existing function
	rowCount: Number            // the actual number of rows, saved to dable.RowCount, replaces the existing function
}
</pre>
					<p>So if you understand what all this is, the server side setup should come pretty naturally.  In case it doesn't, here are examples in some common languages.  Please note that I have not tested these, it's just the general logic required.  I'll be building out the tests in the near future.</p>
					<a class="anchor" id="csharp"></a>
					<p class="lead">C#</p>
<pre class="prettyprint lang-csharp">
//Using ScriptCS
using System.Yaml.Serialization;	//https://yamlserializer.codeplex.com/
using System.IO;
using System.Reflection;
using System.Web.Http;
using System.Web.Http.SelfHost;
using System.Web.Http.Dispatcher;

public class ControllerResolver : DefaultHttpControllerTypeResolver
{
    public override ICollection<Type> GetControllerTypes(IAssembliesResolver assembliesResolver)
    {
        return Assembly.GetExecutingAssembly().GetTypes()
            .Where(x => typeof(System.Web.Http.Controllers.IHttpController).IsAssignableFrom(x)).ToList();
    }
}

public class TestController : ApiController
{
    public string POST(int start, int count, string filter, int sortColumn, bool ascending)
    {
        //get data
         var text = File.ReadAllText("testRead.yaml");
         var serializer = new YamlSerializer();
         var table = serializer.Deserialize(text);

        //filter data
        var result = table.ToList();
        if (!string.IsNullOrEpmty(filter)) {
        	result = new List<string[]>();
        	var filters = filter.Split(' ');
	        foreach (var row in table) {
	        	foreach (var field in row) {
	        		var found = false;
	        		foreach(var search in filters) {
	        			if (field.Contains(search)) {
	        				result.Add(row);
	        				found = true;
	        				break;
	        			}
	        		}
	        		if (found) {
	        			break;
	        		}
	        	}
	        }
	    }

        //sort data
        if (sortColumn > -1) {
        	results.Sort((a, b) => a[sortColumn].CompareTo(b[sortColumn]));
        	if (!ascending) {
        		results = results.Reverse();
        	}
        }

        //return data
        var serializer = new JavascriptSerializer();
        return serializer.Serialize(new {
        	rows = results.ToArray(),
        	includedRowCount = results.Length,
        	rowCount = data.Length
        });
    }
}

var config = new HttpSelfHostConfiguration(new Uri("http://localhost:8080"));
config.Services.Replace(typeof(IHttpControllerTypeResolver), new ControllerResolver());
config.Routes.MapHttpRoute(
    name: "DefaultApi",
    routeTemplate: "api/{controller}");

new HttpSelfHostServer(config).OpenAsync().Wait();
Console.WriteLine("Listening...");
Console.ReadKey();
</pre>
						<a class="anchor" id="php"></a>
						<p class="lead">PHP</p>
<pre class="prettyprint lang-php">
$post = file_get_contents('php://input');
$data = json_decode($post);

$start = $data->start;
$count = $data->count;
$filter = $data->filter;
$sortColumn = $data->sortColumn;
$ascending = $data->ascending;

$filters = explode(' ', $filter);

//get the data
$table = yaml_parse(require('data.yml'));

$results = $table;
//filter the data
if ($filter !== '') {
	$results = [];
	foreach ($table as $row) {
		foreach ($row as $field) {
			$found = false;
			foreach ($filters as $search) {
				if (strpos($field, $search) !== false) {
					array_push($results, $row);
					$found = true;
					break;
				}
			}
			if ($found) {
				break;
			}
		}
	}
}

//sort the data
function cmp($a, $b) {
	$aValue = $a[$sortColumn];
	$bValue = $b[$sortColumn];
    if ($aValue == $bValue) {
        return 0;
    }
    return ($aValue < $bValue) ? -1 : 1;
}

if($sortColumn !== -1) {
	uasort($results, 'cmp');
	if ($ascending) {
		array_reverse($results);
	}
}


//set the return values
$returnValue = (object) array(
	'rows' => $results,
	'includedRowCount' => count($results),
	'rowCount' => count($table));

</pre>
					<a class="anchor" id="nodejs"></a>
					<p class="lead">Javascript (NodeJS)</p>
<pre class="prettyprint lang-js">
var http = require("http"),
	yaml = require('js-yaml'),
	fs   = require('fs');


http.createServer(function(request,response) {
 	var start = request.data.start;
 	var count = request.data.count;
 	var filter = request.data.filter;
 	var sortColumn = request.data.sortColumn;
	var ascending = request.data.ascending;

    //get data
    var text = fs.readFileSync('data.yml', 'utf8');
    var table = yaml.safeLoad(text);

    //filter data
    var result = table;
    if (filter) {
    	result = [];
    	var filters = filter.split(' ');
    	for (var t = 0;t < table.length; ++t) {
    		var row = table[t];
    		for (var r = 0; r < row,length; ++r) {
    			var field = row[r];
    			var found = false;
    			for (var f = 0; f < filters.length; ++f) {
    				if (field.indexOf(filters[f]) > -1) {
    					result.push(row);
    					found = true;
    					break;
    				}
    			}
    			if (found) {
    				break;
    			}
    		}
    	}
    }

    //sort data
    if (sortColumn > -1) {
		result.sort(function(a, b){
			var aValue = a[sortColumn];
			var bValue = b[sortColumn];
		    if (aValue < bValue) {
		        return -1;
		    }
		    if (aValue > bValue) {
		        return 1;
		    }
		    return 0;
		});
		if (!ascending) {
			result.reverse();
		}
    }

    response.writeHeader(200, {"Content-Type": "text/javascript"});
    response.write(JSON.stringify(result));
    response.end();
}).listen(8080);

console.log('Listening...');
</pre>
				</div>
				<div class="col-md-3">
					<div id="affixed">
						<ul class="nav nav-pills nav-stacked gray" role="navigation">
							<li><a href="#basics">Basics</a></li>
							<li><a href="#csharp">C# Example (ScriptCS)</a></li>
							<li><a href="#php">PHP Example</a></li>
							<li><a href="#nodejs">Javascript Example (NodeJS)</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>